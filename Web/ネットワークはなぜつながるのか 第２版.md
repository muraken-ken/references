# ネットワークはなぜつながるのか　第２版 知っておきたいTCP/IP、LAN、光ファイバの基礎知識

## 第1章 Webブラウザがメッセージを作る

### URLの要素

|プロトコル|//|Webサーバー名|ファイルパス|
|---|---|---|---|
|https:|//|example.com|/index.html|

### HTTPの基本的な考え方

- 基本的な考え方

  ```text
  | サーバ | ← |リクエスト・メッセージ（メソッド＋URI）| ← | クライアント |
  | サーバ | → |レスポンス・メッセージ（ステータス）   | → | クライアント |
  ```

- HTTPの主なメソッド
  - GET：情報取得
  - POST：情報送信
  - HEAD：GETと同じだが、ヘッダー情報のみ
  - OPTION：通信オプション
  - PUT：更新
  - DELETE：削除
  - TRACE：リクエスト・ラインとヘッダーをそのまま送り返す
  - CONNECT：暗号化したメッセージをプロキシで転送

- HTTPのヘッダー・メッセージ
  - 付属する情報を付加する

- HTTPのステータスコード
  - 1xx：処理の経過状況などを通知する
  - 2xx：正常終了
  - 3xx：何らかの別のアクションが必要であることを表す
  - 4xx：クライアント側のエラー
  - 5xx：サーバー側のエラー

### IPアドレス

- IPアドレスの構造

  ```text
  IPアドレス        10 .1  .2  .3  00001010.00000001.00000010.00000011
  ネットマスク      255.255.255.0  11111111.11111111.11111111.00000000

  ネットワーク番号  10 .1  .2  .   00001010.00000001.00000010.
  ホスト番号                    3                             00000011

  ※ホスト番号
    全て「0」：サブネット自体を表す
    全て「1」：ブロードキャスト（全機器に送る）
  ```

- ドメイン名とIPアドレス
  - ドメイン名：人間
  - IPアドレス：コンピュータ
  - DNS(Domain Name System)で解決する

- DNS
  - DNSリゾルバ（リゾルバ）：IPアドレスを問合せる
  - 名前解決：IPアドレスを調べる
  - Socketライブラリに入っているモジュール

```text
①アプリケーション（ドメイン名）
②Socket
③DNS問合せメッセージを作成
④DNSサーバーに送る（OSプロトコル・スタック：UDPメッセージ）
⑤LANアダプタ
⑥DNSサーバー
⑦LANアダプタ
⑧DNSサーバーから受信（OSプロトコル・スタック：UDPメッセージ）
⑨DNS回答メッセージを受信（Socket）
⑩名前解決し、アプリケーション継続
```

- DNSサーバーの動作
  - クラス：インターネット以外は消滅したので「IN」
  - タイプ：「A」IPアドレス、「MX」メール配送先 など

|名前|クラス|タイプ|クライアントに返答する内容|
|---|---|---|---|
|www.example.com|IN|A|192.0.2.226|
|example.com|IN|MX|10 mail.example.com|
|mail.example.com|IN|A|192.0.2.227|

- DNSサーバー
  - ルート・ドメインのDNSサーバー（世界で13台）
    - トップレベル・ドメインのDNSサーバー
      - 下位ドメインのDNSサーバー
  - キャッシュで素早く回答

### データ送受信の概要

- OS内部のプロトコル・スタックに依頼する
  - Socketライブラリのプログラムを決められた順番で呼び出す
  - パイプのような通り道ができるイメージ
  - 出入口：ソケット

- データ送受信
  - ソケット作成フェーズ
    - Socketライブラリ：socketモジュールを呼び出す
    - ディスクリプタ（番号札のようなソケット識別する）
  - 接続フェーズ
    - Socketライブラリ：connectモジュールを呼び出す（ディスクリプタ、IPアドレス、ポート番号）
  - 送受信フェーズ
    - Socketライブラリ：writeモジュールを呼び出す（ディスクリプタ、送信データ）
    - Socketライブラリ：readモジュールを呼び出す（受信バッファのメモリを指定）
  - 切断フェーズ
    - Socketライブラリ：closeモジュールを呼び出す

## 第2章 TCP/IPのデータを電気信号にして送る

### プロトコル・スタックの内部構成

- TCP/IPソフトの階層的構造

  ```text
  アプリケーション
    | ネットワーク・アプリケーション   |
    | |Socketライブラリ (|リゾルバ|) | |
  --------------------------------------
  OS
    |プロトコル・スタック              |
    | |TCP| |UDP|                      |
    | |IP | (|ICMP| |ARP|)             |
  --------------------------------------
  ドライバソフト
    |LANドライバ                       |
  --------------------------------------
  ハードウェア
    |LANアダプタ                       |
  --------------------------------------
  ```

- プロトコル・スタック
  - TCP：通常のアプリケーションデータの送受信
  - UDP：短い制御用のデータを送受信（DNSサーバーの問合せなど）
  - IPプロトコル：パケット送受信を制御する
    - ARP：MACアドレスを調べる
    - ICMP：パケットエラー検知

- LANドライバ：LANアダプタのハードウェア制御

- ソケットの実体
  - プロトコル・スタック：ソケットに記録された制御情報を参照し動く

- 制御情報
  - ヘッダーに書き込まれる情報
  - ソケット（プロトコル・スタックのメモリ領域）に記録される情報

- 接続動作の実際
  - TCP担当部分で接続を表すTCPヘッダーを作成
  - TCPヘッダーの送信元と宛先のポート番号で接続するソケットを特定
  - ACK：返答の時にコントロール・ビットを1にする
  - コネクション：パイプのようなもの

- データの送受信
  - MTU(Maximum transmission Unit)：1つのパケットで運ぶことができるデジタルデータの最大長のこと（通常1500バイト）
  - MSS(Maximum Segment Size)：ヘッダーを除いて1つのパケットで運べるTCPデータの最大長

  ```text
  |プリアンブル／              |MAC     |IP      |TCP     |データ|FCS|
  |スタート・フレーム・デリミタ|ヘッダー|ヘッダー|ヘッダー|      |   |
                                        ←  MTU                     →
                                                          ←MSS →
  ```

- データが大きい時は分割して送る

  ```text
  |HTTPヘッダー|メッセージ・ボディ|
  ↓              ↓              ↓
  |データ1        |データ2        |

  ※TCPヘッダーにデータのシーケンス番号を記録
  ※ACK番号で届いたことを確認（受信確認応答）
  ```

- パケットのやりとり
  - ピンポン方式（データ送信／受信確認応答を1セットで）
  - ウインドウ制御方式（ACKを待つ間にもデータ送信する）
    - ウインドウ・サイズ（受信可能なデータ量の最大値（空きメモリ量：ウインドウ・フィールドで通知））

- ソケット抹消
  - サーバーからFIN送信
  - クライアントがACK送信
  - クライアントがFIN送信
  - サーバーがACK送信
  - 一定時間を過ぎてソケット抹消

### TCP/IPプロトコル

- IPとイーサネットのパケット送受信動作
  - TCP/IPのパケット

    ```text
    |MACヘッダー|IPヘッダー|TCPヘッダー|データ断片|
                           ← TCPのパケット      →
                ← IPのパケット                  →
    ← TCP/IPのパケット                          →
    ```

- IP担当の仕事
  - MACヘッダー：イーサネット用のヘッダー（MACアドレス）を付加
  - IPヘッダー：IP用のヘッダー（IPアドレス）を付加
  - 経路表のGateway欄の値でパケットを渡す相手を判断する

- IPヘッダー
  - 宛先IPアドレス
  - 送信元IPアドレス
  - その他の制御値

- MACヘッダー（イーサネット用ヘッダー）
  - 宛先MACアドレス
  - 送信元MACアドレス
  - イーサ・タイプ
    - 0000-05DC IEEE802.3
    - 0800      IPプロトコル
    - 0806      ARPプロトコル
    - 86DD      IPv6

- ARP：MACアドレスを調べる

- LANアダプタ
  - ユニークな値のMACアドレスをROMに格納

- LANアダプタの構成
  - バッファ・メモリー：送受信するパケットを一時保管
  - MAC：衝突検出、再送などの制御
  - PHY（MAU）：送受信回路
  - RJ-45コネクタ：物理コネクタ

- LANアダプタのパケット

  ```text
  |プリアンブル／              |MAC     |IP      |TCP     |データ|FCS|
  |スタート・フレーム・デリミタ|ヘッダー|ヘッダー|ヘッダー|      |   |
   ↑LANアダプタ                                        LANアダプタ↑
  ```

- LANアダプタのパケットの働き
  - プリアンブル：クロック信号（速度）識別
  - スタート・フレーム・デリミタ：データのはじまり
  - FCS：誤り検出

- 衝突
  - パケットの送受信タイミングの重複
  - ジャミング信号を出し、一定時間待つ

- ICMPの働き
  - 送信相手にエラーを通知

### UDPプロトコル

- UDPプロトコル
  - 送り直しの必要のない通信
    - 制御用の短いデータ
    - 音声や動画のデータ

- UDPヘッダー
  - 送信元ポート番号
  - 宛先ポート番号
  - データ長
  - チェックサム

## 第3章 ケーブルの先はLAN機器だった

### LANケーブル

- LANケーブル
  - ツイスト・ペア・ケーブル：クロストーク軽減
  - カテゴリが上がると通信速度が高速化

### リピータハブ

- LANアダプタ＋リピータハブ
  - クロスケーブル
  - 全機器に信号を送信する

### スイッチング・ハブ

- MAC回路：MACアドレスは割り当てられていない
- MACアドレス・テーブルでMACアドレスを調べ、該当するポートから信号を送信する
- 全二重モードで送信と受信を同時に実行できる
- オートネゴシエーション：最適な伝送速度で送る（リンクパルス）

### ルーターのパケット中継動作

- ルーター
  - ポート部分（各ポートにMACアドレス、IPアドレスが割り当てられている）
  - ルーティング・テーブル（IPアドレスで中継先を判断）
    - ホスト番号は無視し、ネットワーク番号のみ調べる
  - ポートのMACアドレスに該当するパケットのみ受信し、その他は捨てる
    - ルーターで中継するパケットの宛先MACアドレスには、ルーターのポートのMACアドレスが書いてある
  - 該当する宛先がない場合は、デフォルト・ゲートウェイに送信する
  - フラグメンテーション：大きいパケットはルータでも分割する

- アドレス変換機能
  - プライベート・アドレスとグローバル・アドレスの変換
  - ポート番号も書き換える

- パケット・フィルタリング機能
  - 不正侵入を防ぐ

## 第4章 アクセス回線を通ってインターネットの内部へ

### ADSL技術

### FTTH（光ファイバ回線）

- 光ファイバ
  - シングルモード
  - マルチモード

- 配線接続
  - メディアコンバータ（1本の光ファイバを占有）
  - ONU＋光スプリッタ（1本の光ファイバを共有）

### PPPとトンネリング

- 本人確認：PPPoE
  - BAS → RADIUSプロトコル → 認証サーバー

- トンネリング
  - BASとユーザーをパイプでつなぐイメージ

### プロバイダの内部

- プロバイダの内部
  - POP（Point of Presence）
  - NOC（Network Operation Center）：プロバイダの中核

### プロバイダ間

- BGP：プロバイダ間で経路情報を交換する
  - 非トランジット、ピア

- IX（Internet eXchange）
  - JPIX
  - NSPIXP2
  - JPNAP

## 第5章 サーバー側のLANには何がある

### サーバーの接続形態

- ルーターで直結
- ファイアウォールで分離
- 回線事業者のデータセンター

### ファイアウォールの仕組みと働き

- パケット・フィルタリング型が主流

- 設定条件
  - MACヘッダー
  - IPヘッダー
  - TCPヘッダー、UDPヘッダー
  - ICMPメッセージの中身
  - ポート番号
  - 接続方向（コントロール・ビット）

- アドレス変換

### サーバーの負荷分散

- ラウンドロビン：DNSサーバーで振り分け
- ロードバランサー（負荷分散装置）

### キャッシュ・サーバー

- キャッシュ・サーバー
  - フォワード・プロキシ（クライアント側置く）
    - ブラウザ設定が必須（プロキシ・サーバー）
  - リバース・プロキシ（サーバー側に置く）
    - ブラウザ設定不要
  - トランスペアレント・プロキシ

### コンテンツ配信サービス（Content Delivery Service）

- CDSP（CDSプロバイダー）
  - キャッシュサーバーで配信

- リダイレクト用サーバーで振り分ける

## 第6章 Webサーバーに到着し、応答データがWebブラウザに戻る

- サーバーの概要
  - Socketライブラリのモジュールがクライアントと異なる

- サーバーのアプリケーションの構造
  - サーバーOS：マルチタスク、マルチスレッド

- サーバー側のソケットとポート番号
  - ソケットを作る（ソケット作成フェーズ）
  - ソケットを接続待ち状態にする（接続待ちフェーズ）
  - 接続を受け付ける（接続受け付けフェーズ）
  - データを送受信する（送受信する）
  - パイプを外してソケットを抹消する（切断フェーズ）

- ソケット識別：ディスクリプタ
  - 接続待ちのソケットにはクライアント側のIP

- 基本的にはクライアント側の逆に上位層に遡って、レスポンス・メッセージを返す
